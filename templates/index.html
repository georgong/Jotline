<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>CanvasNote ç¼–è¾‘å™¨ï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆ v0.3.2ï¼‰</title>
  <link href="https://https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static',filename = 'styles.css') }}" />
</head>
<body>
  <div class="sidebar">
    <h3>ğŸ“‚ é¡µé¢å¯¼èˆª</h3>
      <!-- åé¢ä»loadä¸­æ›¿æ¢ -->
      <ul id="page-list"></ul>
  </div>

  <div class="workspace">
    <div class="notebook-container" id="inbox"></div>
    <div class="notebook-container" id="canvas_ds190"></div>
    <div class="notebook-container" id="canvas_timeline"></div>
  </div>
  <!-- åŠ è½½å’Œä¿å­˜æŒ‰é’® -->
  <div style="margin-top: 2rem; text-align: center; display: flex; flex-direction: column; gap: 1rem;">
    <button class="doodle-btn-load" onclick="load_note()">Load Note</button>
    <button class="doodle-btn" onclick="save_note()">Save Note</button>
  </div>


  <div class="alert-overlay" id="alertOverlay"></div>

<div class="notebook-alert" id="customAlert">
  <h3>ğŸ“¢ æç¤º</h3>
  <p id="alertMessage">è¿™æ˜¯ä¸€ä¸ªå¼¹çª—å†…å®¹</p>
  <button class="notebook-alert-btn" onclick="closeAlert()">çŸ¥é“äº†</button>
  <div style="clear: both;"></div>
</div>


  <script>
// CanvasNote ä¸»é€»è¾‘æ•´ç†ç‰ˆï¼ˆæ”¯æŒé¡µé¢é¡ºåº + åç§°ä¿å­˜ï¼Œinbox å›ºå®šé¦–ä½ï¼‰

// =============================
// ğŸ” é¡µé¢ä¸å¯¼èˆªç®¡ç†
// =============================
let pageMap = [
  ["inbox", "ğŸ“ éšæ‰‹è®°"],
  ["canvas_ds190", "ğŸ“˜ DS190 Canvas"],
  ["canvas_timeline", "ğŸ“ æ—¶é—´è½´ Canvas"]
];


function renderSidebar() {
  const ul = document.getElementById('page-list');
  ul.innerHTML = '';
  pageMap.forEach(([id, label]) => {
    const li = document.createElement('li');
    li.dataset.pageId = id;

    const span = document.createElement('span');
    span.className = 'sidebar-label';
    span.textContent = label;

    const underlineContainer = document.createElement('div');
    underlineContainer.className = 'underline-container';
    underlineContainer.innerHTML = `
      <svg width="100%" height="12" viewBox="0 0 300 20">
        <path class="pencil-line" d="M0,10 C30,5 60,15 90,10 C120,5 150,15 180,10 C210,5 240,15 270,10 C290,15 300,5 300,10" />
      </svg>
    `;

    li.appendChild(span);
    li.appendChild(underlineContainer);
    li.onclick = () => switchPage(id);
    ul.appendChild(li);
  });
}

function switchPage(id) {
  document.querySelectorAll('.notebook-container').forEach(div => div.style.display = 'none');
  const target = document.getElementById(id);
  if (!target) return;
  target.style.display = 'block';

  target.querySelectorAll('.note-block').forEach(block => {
    const textarea = block.querySelector('textarea');
    const preview = block.querySelector('.preview-block');
    if (textarea && textarea.style.display !== 'none' && preview.innerHTML.trim() === "") {
      renderBlockFromTextarea(textarea, preview);
    }
  });

  document.querySelectorAll('.sidebar li').forEach(li => {
    li.classList.remove('active-page');
    const line = li.querySelector('.pencil-line');
    if (line) line.style.strokeDashoffset = '300';
  });

  const activeLi = document.querySelector(`.sidebar li[data-page-id="${id}"]`);
  if (activeLi) {
    activeLi.classList.add('active-page');
    const line = activeLi.querySelector('.pencil-line');
    if (line) line.style.strokeDashoffset = '0';
  }
}

function switchCanvasRelative(offset) {
  const keys = pageMap.map(([id]) => id);
  const currentId = document.querySelector('.sidebar li.active-page')?.dataset.pageId;
  const currentIndex = keys.indexOf(currentId);
  if (currentIndex === -1) return;
  const nextId = keys[(currentIndex + offset + keys.length) % keys.length];
  switchPage(nextId);
}

function openCanvasSearch() {
  const query = prompt("ğŸ” è¾“å…¥ Canvas åç§°ç‰‡æ®µ");
  if (!query) return;
  const matched = pageMap.find(([id, label]) => id.includes(query) || label.includes(query));
  matched ? switchPage(matched[0]) : showAlert(`æœªæ‰¾åˆ°åŒ¹é…çš„é¡µé¢ï¼š${query}`);
}

function createNewCanvas() {
  //const name = prompt("ğŸ†• æ–°é¡µé¢åç§°");
  const name = "newcanvas"
  if (!name) return;
  const id = `canvas_${Date.now()}`;
  pageMap.push([id, "ğŸ“„ " + name]);

  const container = document.createElement("div");
  container.className = "notebook-container";
  container.id = id;
  document.querySelector('.workspace').appendChild(container);
  createNoteBlock(container, "");
  renderSidebar();
  switchPage(id);
}

// =============================
// ğŸ“ Block æ¸²æŸ“ä¸äº¤äº’
// =============================
function createNoteBlock(container, initial = "") {
  const wrapper = document.createElement("div");
  wrapper.className = "note-block";

  const textarea = document.createElement("textarea");
  textarea.value = initial;

  const preview = document.createElement("div");
  preview.className = "preview-block";

  textarea.addEventListener("input", () => {
    autoResize(textarea);
    hasChanges = true;
  });
  textarea.addEventListener("blur", () => renderBlockFromTextarea(textarea, preview));

  preview.addEventListener("click", () => {
    textarea.style.display = "block";
    preview.style.display = "none";
    autoResize(textarea);
    textarea.focus();
  });

  wrapper.appendChild(textarea);
  wrapper.appendChild(preview);
  container.appendChild(wrapper);
  autoResize(textarea);
}

async function callLLM(prompt) {
  const res = await fetch("/llm", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });
  const data = await res.json();
  return data.reply;
}

function renderBlockFromTextarea(textarea, preview) {
  const val = textarea.value.trim();
  if (!val) return;
  const matches = [...val.matchAll(/(\\\[[^\]]+])/g)];
  const aiReplies = [...val.matchAll(/\[AI\]/g)];

  if (matches.length > aiReplies.length) {
    const nextPrompt = matches[aiReplies.length][1]; // å¯¹åº”ä¸‹ä¸€ä¸ªæœªå›å¤çš„
    callLLM(nextPrompt).then(reply => {
      const replyText = `\n\n[AI] ${reply}`;
      textarea.value += replyText;
      hasChanges = true;
      renderBlockFromTextarea(textarea, preview); // é€’å½’è§¦å‘ä¸‹ä¸€æ¡
    });
    return;
  }
  const split = splitBlocks(val);
  preview.innerHTML = "";

  split.forEach(block => {
    const div = document.createElement("div");
    if (block.type === 'canvas') {
      div.className = "canvas-preview";
      div.innerHTML = `
        <div class="canvas-title">ğŸ“˜ [${block.attrs.type}] ${block.attrs.title || "æœªå‘½å Canvas"}</div>
        <div class="canvas-note">${marked.parse(preprocessHighlightCommands(block.content))}</div>
      `;
    } else {
      div.className = "canvas-note";
      div.innerHTML = marked.parse(preprocessHighlightCommands(block.content));
    }
    preview.appendChild(div);
  });

  renderMathInElementSafe(preview);
  textarea.style.display = "none";
  preview.style.display = "block";
}

function autoResize(textarea) {
  textarea.style.height = "auto";
  textarea.style.height = Math.max(textarea.scrollHeight, 40) + "px";
}

function splitBlocks(rawText) {
  const blocks = [];
  const canvasRegex = /:::canvas([^\n]*)\n([\s\S]*?)\n?:::/g;
  let lastIndex = 0;
  let match;

  while ((match = canvasRegex.exec(rawText)) !== null) {
    const start = match.index;
    const end = canvasRegex.lastIndex;
    if (start > lastIndex) {
      blocks.push({ type: 'markdown', content: rawText.slice(lastIndex, start).trim() });
    }
    const attrLine = match[1].trim();
    const content = match[2].trim();
    const attrs = {};
    attrLine.split(/\s+/).forEach(pair => {
      const [k, v] = pair.split('=');
      if (k && v) attrs[k] = v.replace(/"/g, '');
    });
    blocks.push({ type: 'canvas', attrs, content, raw: match[0] });
    lastIndex = end;
  }
  if (lastIndex < rawText.length) {
    blocks.push({ type: 'markdown', content: rawText.slice(lastIndex).trim() });
  }
  return blocks;
}

function preprocessHighlightCommands(rawText) {
  return rawText.replace(/\\\[(.+?)\]/g, (_, p1) => {
    return `<span class="highlight-command">\\[${p1}]</span>`;
  });
}

function renderMathInElementSafe(target) {
  if (typeof renderMathInElement === "function") {
    renderMathInElement(target, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false }
      ],
      throwOnError: false
    });
  }
}

// =============================
// ğŸ’¾ å­˜å‚¨ä¸æ¢å¤
// =============================
let hasChanges = false

function getAllNotes() {
  const pages = {};
  const notes = {};
  pageMap.forEach(([id, name]) => {
    const container = document.getElementById(id);
    if (!container) return;
    const blocks = container.querySelectorAll('.note-block textarea');
    notes[id] = Array.from(blocks).map(t => t.value);
    pages[id] = name;
  });
  return { pages, notes };
}

function save_note() {
  const data = getAllNotes();
  fetch('/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(res => res.json())
    .then(json => {
      showAlert(json.status === "success" ? "ğŸ’¾ æœ¬åœ° JSON ä¿å­˜æˆåŠŸï¼" : "âš ï¸ ä¿å­˜å¤±è´¥ï¼");
    })
    .catch(err => {
      console.error(err);
      showAlert("âŒ æ— æ³•è¿æ¥åç«¯ä¿å­˜æ–‡ä»¶ï¼");
    });
}

function load_note() {
  fetch('/load')
    .then(res => res.json())
    .then(json => {
      if (json.status === 'success') {
        const { pages, notes } = json.data;
        pageMap = Object.entries(pages);

        // å›ºå®š inbox åœ¨æœ€å‰é¢
        const index = pageMap.findIndex(([id]) => id === 'inbox');
        if (index > 0) {
          const inboxEntry = pageMap.splice(index, 1)[0];
          pageMap.unshift(inboxEntry);
        }

        document.querySelectorAll('.notebook-container').forEach(c => c.remove());

        Object.entries(notes).forEach(([pageId, blocks]) => {
          let container = document.getElementById(pageId);
          if (!container) {
            container = document.createElement('div');
            container.className = 'notebook-container';
            container.id = pageId;
            document.querySelector('.workspace').appendChild(container);
          }
          blocks.forEach(text => createNoteBlock(container, text));
        });

        renderSidebar();
        switchPage('inbox');
        showAlert("ğŸ“‚ ç¬”è®°å·²åŠ è½½ï¼");
      } else {
        showAlert(json.status === 'empty' ? "ğŸ“­ æ²¡æœ‰ä¿å­˜çš„ç¬”è®°æ–‡ä»¶ï¼" : "âš ï¸ åŠ è½½å¤±è´¥ï¼š" + json.message);
      }
    })
    .catch(err => {
      console.error(err);
      showAlert("âŒ åŠ è½½å¤±è´¥ï¼Œæ— æ³•è¿æ¥åç«¯ï¼");
    });
}

// =============================
// ğŸ“¢ Alert ç³»ç»Ÿ
// =============================
function showAlert(message = "å·²å®Œæˆæ“ä½œ") {
  document.getElementById("alertMessage").textContent = message;
  document.getElementById("customAlert").style.display = "block";
  document.getElementById("alertOverlay").style.display = "block";
}

function closeAlert() {
  document.getElementById("customAlert").style.display = "none";
  document.getElementById("alertOverlay").style.display = "none";
}

// =============================
// âŒ¨ï¸ å¿«æ·é”®
// =============================
document.addEventListener("keydown", function(e) {
  const isInput = e.target.tagName === "TEXTAREA" || e.target.tagName === "INPUT";
  if (e.ctrlKey && e.code === "ArrowUp") {
    e.preventDefault();
    window.alert("â¬†ï¸ Ctrl + ArrowUp è¢«è§¦å‘");
    switchCanvasRelative(-1);
  } else if (e.ctrlKey && e.code === "ArrowDown") {
    e.preventDefault();
    window.alert("â¬‡ï¸ Ctrl + ArrowDown è¢«è§¦å‘");
    switchCanvasRelative(1);
  } else if (e.ctrlKey && e.code === "KeyK") {
    e.preventDefault();
    window.alert("ğŸ” Ctrl + K æœç´¢é¡µé¢è§¦å‘");
    openCanvasSearch();
  } else if (e.ctrlKey && e.code === "KeyN") {
    e.preventDefault();
    createNewCanvas();
  } else if (e.code === "Escape") {
    window.alert("â›” ESC è¢«è§¦å‘");
    closeAlert();
  } else if (e.ctrlKey && e.code === "Enter") {
    if (isInput) {
      e.preventDefault();
      window.alert("ğŸ–‹ Ctrl + Enter æ¸²æŸ“å½“å‰ block");
      const wrapper = e.target.closest('.note-block');
      if (wrapper) {
        const preview = wrapper.querySelector('.preview-block');
        renderBlockFromTextarea(e.target, preview);
      }
    }
  }
});

// =============================
// ğŸš€ åˆå§‹åŒ–
// =============================
renderSidebar();
pageMap.forEach(([id]) => {
  const container = document.getElementById(id);
  if (container) createNoteBlock(container, "");
});
switchPage('inbox');

  </script>
</body>
</html>
