<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>CanvasNote 编辑器（v0.3.2 本地保存版）</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Patrick Hand', cursive;
      background: #fefefe;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: #fefdf7;
      border-right: 1px solid #eee;
      padding: 1rem;
    }

    .sidebar h3 {
      margin-top: 0;
      font-size: 1.1rem;
      color: #555;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar li {
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 6px;
    }

    .sidebar li:hover {
      background: #f0f0ee;
    }

    .workspace {
      flex-grow: 1;
      padding: 2rem;
      display: flex;
      justify-content: center;
      overflow-y: auto;
    }

    .notebook-container {
      width: 720px;
      height: 1024px;
      background: #fffbf0;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.04);
      border: 1px solid #eee;
      padding: 2rem;
      overflow-y: auto;
      display: none;
    }

    .note-block {
      margin-bottom: 1.5rem;
    }

    textarea {
      width: 100%;
      font-family: 'Patrick Hand', cursive;
      font-size: 16px;
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      line-height: 24px;
      padding: 4px 6px;
    }

    .preview-block {
      display: none;
      cursor: pointer;
      font-family: 'Patrick Hand', cursive;
      font-size: 16px;
      line-height: 24px;
    }

    .canvas-preview {
      background: #ffffff;
      border: 2px dashed #8c9eff;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(140, 158, 255, 0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .canvas-title {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: #3f51b5;
    }

    .canvas-note {
      font-size: 1rem;
      color: #444;
    }

    .highlight-command {
      background: #fdf1f2;
      color: #d14b57;
      padding: 0 4px;
      border-radius: 4px;
      font-weight: bold;
    }

    #saveBtn {
      font-family: 'Patrick Hand', cursive;
      font-size: 18px;
      padding: 8px 16px;
      border: 2px dashed #888;
      background: #fff8e1;
      border-radius: 12px;
      box-shadow: 2px 2px 0 #ccc;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #saveBtn:hover {
      background: #fff3c4;
      box-shadow: 3px 3px 0 #bbb;
      transform: translate(-1px, -1px);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>📂 页面导航</h3>
    <ul>
      <li onclick="switchPage('inbox')">📝 随手记</li>
      <li onclick="switchPage('canvas_ds190')">📘 DS190 Canvas</li>
      <li onclick="switchPage('canvas_timeline')">📐 时间轴 Canvas</li>
    </ul>

    <div style="margin-top: 2rem; text-align: center;">
      <button id="saveBtn" onclick="save_note()">💾 保存</button>
    </div>
  </div>

  <div class="workspace">
    <div class="notebook-container" id="inbox"></div>
    <div class="notebook-container" id="canvas_ds190"></div>
    <div class="notebook-container" id="canvas_timeline"></div>
  </div>

  <script>
    function renderMathInElementSafe(target) {
      if (typeof renderMathInElement === "function") {
        renderMathInElement(target, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false }
          ],
          throwOnError: false
        });
      }
    }

    function preprocessHighlightCommands(rawText) {
      return rawText.replace(/\\\[(.+?)\]/g, (_, p1) => {
        return `<span class="highlight-command">\\[${p1}]</span>`;
      });
    }

    function splitBlocks(rawText) {
      const blocks = [];
      const canvasRegex = /:::canvas([^\n]*)\n([\s\S]*?)\n?:::/g;
      let lastIndex = 0;
      let match;

      while ((match = canvasRegex.exec(rawText)) !== null) {
        const start = match.index;
        const end = canvasRegex.lastIndex;

        if (start > lastIndex) {
          blocks.push({
            type: 'markdown',
            content: rawText.slice(lastIndex, start).trim()
          });
        }

        const attrLine = match[1].trim();
        const content = match[2].trim();
        const attrs = {};
        attrLine.split(/\s+/).forEach(pair => {
          const [k, v] = pair.split('=');
          if (k && v) attrs[k] = v.replace(/"/g, '');
        });

        blocks.push({
          type: 'canvas',
          attrs,
          content,
          raw: match[0]
        });

        lastIndex = end;
      }

      if (lastIndex < rawText.length) {
        blocks.push({
          type: 'markdown',
          content: rawText.slice(lastIndex).trim()
        });
      }

      return blocks;
    }

    function renderBlockFromTextarea(textarea, preview) {
        const val = textarea.value.trim();
        if (!val) return;

        const split = splitBlocks(val);
        preview.innerHTML = "";

        split.forEach(block => {
          const div = document.createElement("div");
          if (block.type === 'canvas') {
            div.className = "canvas-preview";
            div.innerHTML = `
              <div class="canvas-title">📘 [${block.attrs.type}] ${block.attrs.title || "未命名 Canvas"}</div>
              <div class="canvas-note">${marked.parse(preprocessHighlightCommands(block.content))}</div>
            `;
          } else {
            div.className = "canvas-note";
            div.innerHTML = marked.parse(preprocessHighlightCommands(block.content));
          }
          preview.appendChild(div);
        });

        renderMathInElementSafe(preview);
        textarea.style.display = "none";
        preview.style.display = "block";
    }

    function createNoteBlock(container, initial = "") {
      const wrapper = document.createElement("div");
      wrapper.className = "note-block";

      const textarea = document.createElement("textarea");
      textarea.value = initial;

      const preview = document.createElement("div");
      preview.className = "preview-block";

      textarea.addEventListener("input", () => autoResize(textarea));
      textarea.addEventListener("blur", () => renderBlockFromTextarea(textarea, preview));
      preview.addEventListener("click", () => {
        textarea.style.display = "block";
        preview.style.display = "none";
        autoResize(textarea);
        textarea.focus();
      });

      wrapper.appendChild(textarea);
      wrapper.appendChild(preview);
      container.appendChild(wrapper);
      autoResize(textarea);
    }

    function autoResize(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = Math.max(textarea.scrollHeight, 40) + "px";
    }

    function switchPage(id) {
      document.querySelectorAll('.notebook-container').forEach(div => {
        div.style.display = 'none';
      });
      const target = document.getElementById(id);
      if (target) {
        target.style.display = 'block';
        target.querySelectorAll('.note-block').forEach(block => {
          const textarea = block.querySelector('textarea');
          const preview = block.querySelector('.preview-block');
          if (textarea && textarea.style.display !== 'none' && preview.innerHTML.trim() === "") {
            renderBlockFromTextarea(textarea, preview);
          }
        });
      }
    }

    function getAllNotes() {
      const pages = ['inbox', 'canvas_ds190', 'canvas_timeline'];
      const data = {};
      pages.forEach(id => {
        const container = document.getElementById(id);
        const blocks = container.querySelectorAll('.note-block textarea');
        data[id] = Array.from(blocks).map(textarea => textarea.value);
      });
      return data;
    }

    function save_note() {
      const data = getAllNotes();
      fetch('/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      }).then(res => res.json())
        .then(json => {
          if (json.status === "success") {
            alert("💾 本地 JSON 保存成功！");
          } else {
            alert("⚠️ 保存失败！");
          }
        }).catch(err => {
          alert("❌ 无法连接后端保存文件！");
          console.error(err);
        });
    }

    // 页面初始化
    const inbox = document.getElementById("inbox");
    const canvas_ds190 = document.getElementById("canvas_ds190");
    const canvas_timeline = document.getElementById("canvas_timeline");

    createNoteBlock(inbox, "");

    createNoteBlock(canvas_ds190, `:::canvas type=lecture_note title="高斯分布":::
高斯分布对称，峰值在 $\\mu=0$，方差为 $\\sigma^2$
:::`);

    createNoteBlock(canvas_timeline, `:::canvas type=timeline title="今日任务":::
@09:00 - 阅读论文  
@14:00 - \\[联系导师]
:::`);

    switchPage('inbox');
  </script>
</body>
</html>
